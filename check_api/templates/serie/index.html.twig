{% extends 'base.html.twig' %}

{% block title %} {{ title }} {% endblock %}

{% block body %}
<style>
    li {
        list-style-type: none;
    }
    ul {
        padding: 0%;
    }
    a {
        text-decoration: none;
        color: inherit;
    }
    .truncate-4 {
        display: -webkit-box;
        -webkit-line-clamp: 4;   /* nombre de lignes */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .filters {
        border-bottom: solid 1px grey;
    }
    .filter-container {
        position: relative;
        display: inline-block;
    }
    .filter-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 6px;
        transition: color 0.3s ease, background-color 0.3s ease;
    }
    .filter-label:hover {
        /* color: rgb(166, 166, 166); */
        /* background: #222; */
        opacity: 75%;
    }
    .filter-icon {
        width: 12px;
        height: 12px;
        transition: transform 0.3s ease;
    }
    .filter-label select:focus + .filter-icon,
    .filter-label select:active + .filter-icon {
        transform: rotate(-180deg);
    }

    /* Select stylé */
    .filter-label select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 14px;
        padding-left: 5px;
        cursor: pointer;
        width: fit-content;
    }
    .filter-label option {
        background-color: #373b3f;
    }

    th, td { padding-left: 10px; padding-right: 25px; }
    .listCards {
        margin: auto;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        grid-gap: 5px;
        grid-auto-rows: minmax(100px, auto);
        position: relative;
        width: fit-content;
        margin-bottom: 100px;
    }
    .carousel-item {
        display: none;
    }
    /* .card {
    }
    .card:hover {
    } */
    .cardPoster {
        position: relative;
        border-radius: 4%;
        border: solid 1px #666666;
        box-shadow: 0 5px 10px #14181c;
        margin: 2px;
        /* height: fit-content; */
        width: fit-content;
    }
    .cardPoster:hover {
        border: solid 3px #ffffff;
        margin: 0;
    }
    .poster{
        border-radius: 3%;
        height: 225px;
        width: 150px;
    }
    .serieTitle{
        position: absolute;
    }
</style>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">
        {{ message }}
    </div>
{% endfor %}

{% set filterOptions = {
    'type': types,
    'country': countries,
    'release_date': release_dates,
    'platform': platforms,
    'nb_season': nb_seasons,
    'status': status,
} %}

<div>
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h2 class="m-0">Serie's list</h2>
        {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('admin_index') }}" class="btn btn-primary">Panneau Admin</a>
        {% endif %}
    </div>
    <div class="d-flex justify-content-between">
        <form id="filtersList" class="filters d-flex justify-content-between align-items-center gap-3 mb-3 w-100">
            {# <p class="m-0">Filters</p> #}
            <div class="d-flex p-0">
                {% for name, options in filterOptions %}
                    <div class="filter-container p-0">
                        <label class="filter-label">
                            <select name="{{ name }}">
                                <option value="">{{ name|capitalize|replace({'_': ' '}) }}</option>
                                {% for option in options %}
                                    <option value="{{ option|lower }}">{{ option|capitalize }}</option>
                                {% endfor %}
                            </select>
                            <svg class="filter-icon" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                                <path d="M165.6 349.8c-1.4 1.3-3.5 2.2-5.6 2.2s-4.2-.8-5.6-2.2L34.2 236.3c-1.4-1.3-2.2-3.2-2.2-5.2c0-3.9 3.2-7.1 7.1-7.1l241.7 0c3.9 0 7.1 3.2 7.1 7.1c0 2-.8 3.8-2.2 5.2L165.6 349.8zm22 23.3L307.7 259.6c7.8-7.4 12.3-17.7 12.3-28.4c0-21.6-17.5-39.1-39.1-39.1L39.1 192C17.5 192 0 209.5 0 231.1c0 10.8 4.4 21.1 12.3 28.5L132.4 373.1c7.4 7 17.3 10.9 27.6 10.9s20.1-3.9 27.6-10.9z"/>
                            </svg>
                        </label>
                    </div>
                {% endfor %}
            </div>
        </form>
        <div>
            <input
                type="text"
                name="searchbar"
                id="searchbar"
                class="searchbar"
                placeholder="Rechercher une série..."
            />
        </div>
    </div>
</div>
<div class="carousel-container">
    <div class="carousel-controls mx-auto w-50 d-flex justify-content-around align-items-center mb-4">
        <button id="prevBtn" class="btn btn-secondary py-1">←</button>
        <span id="pageIndicator"></span>
        <button id="nextBtn" class="btn btn-secondary py-0">→</button>
    </div>
    <ul class="listCards" id="carousel">
        {% for serieRandom in seriesRandomLimited %}
            <li class="bg-dark carousel-item" data-title="{{ serieRandom.title|lower }}">
                <article class="cardPoster">
                    <a href="{{ path('serie_show', { slug: serieRandom.slug }) }}">
                        <img class="poster" src={{ serieRandom.poster_url }} alt={`poster {{ serieRandom.title }}`} />
                    </a>
                </article>
            </li>
        {% endfor %}
    </ul>
</div>

<script>

    // -------------------- Carrousel de séries --------------------
    const itemsPerPage = 24;
    let currentPage = 0;

    function getItems() {
        return document.querySelectorAll('.carousel-item');
    }

    function getTotalPages() {
        return Math.ceil(getItems().length / itemsPerPage);
    }

    const pageIndicator = document.getElementById('pageIndicator');

    function updatePageIndicator() {
        const totalPages = getTotalPages();
        pageIndicator.textContent = `Page ${currentPage + 1} / ${totalPages}`;
    }

    function updateButtonsVisibility() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const totalPages = getTotalPages();

        prevBtn.style.visibility = currentPage === 0 ? 'hidden' : 'visible';
        nextBtn.style.visibility = currentPage >= totalPages - 1 ? 'hidden' : 'visible';
    }

    function showPage(page) {
        const items = getItems();
        const start = page * itemsPerPage;
        const end = start + itemsPerPage;

        items.forEach((item, index) => {
            item.style.display = (index >= start && index < end) ? 'block' : 'none';
        });

        updatePageIndicator();
        updateButtonsVisibility();
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
        const totalPages = getTotalPages();
        if (currentPage < totalPages - 1) {
            currentPage++;
            showPage(currentPage);
        }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            showPage(currentPage);
        }
    });

    showPage(currentPage);


    // -------------------- Filtres d'affichage séries --------------------

    function updateList(series) {
        const list = document.querySelector('.listCards');
        if (!list) return;

        list.innerHTML = '';

        if (series.length === 0) {
            list.innerHTML = '<p class="text-muted">Aucune série trouvée</p>';
            return;
        }

        series.forEach(serie => {
            list.insertAdjacentHTML('beforeend', `
                <li class="bg-dark carousel-item">
                    <article class="cardPoster">
                        <a href="/serie/${serie.slug}">
                            <img class="poster" src="${serie.posterUrl}" alt="poster ${serie.title}">
                        </a>
                    </article>
                </li>
            `);
        });

        currentPage = 0;
        showPage(currentPage);
    }


    const filtersForm = document.getElementById('filtersList');

    if (filtersForm) {
        filtersForm.addEventListener('change', () => {
            const formData = new FormData(filtersForm);
            const params = new URLSearchParams(formData);

            fetch('/api/series?' + params.toString())
                .then(res => {
                    if (!res.ok) throw new Error('API error');
                    return res.json();
                })
                .then(data => {
                    updateList(data);
                })
                .catch(err => console.error(err));
        });
    }

    const searchBar = document.getElementById('searchbar');
    const cards = document.querySelectorAll('#carousel .carousel-item');

    searchBar.addEventListener('input', () => {
        const searchValue = searchBar.value.toLowerCase().trim();

        cards.forEach(card => {
            const title = card.dataset.title;

            if (title.includes(searchValue)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });


</script>

{% endblock %}
