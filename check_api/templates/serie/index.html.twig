{# {% extends 'base.html.twig' %}

{% block title %}Hello SerieController!{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

<div class="example-wrapper">
    <h1>Hello {{ controller_name }}! ‚úÖ</h1>

    This friendly message is coming from:
    <ul>
        <li>Your controller at <code>C:/Users/joann/Documents/GitHub/CheckSerieBox/check_api/src/Controller/SerieController.php</code></li>
        <li>Your template at <code>C:/Users/joann/Documents/GitHub/CheckSerieBox/check_api/templates/serie/index.html.twig</code></li>
    </ul>
</div>
{% endblock %} #}

{% extends 'base.html.twig' %}

{% block title %} {{ title }} {% endblock %}

{% block body %}
<style>
    li {
        list-style-type: none;
    }
    ul {
        padding: 0%;
    }
    a {
        text-decoration: none;
        color: inherit;
    }
    .truncate-4 {
        display: -webkit-box;
        -webkit-line-clamp: 4;   /* nombre de lignes */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .filters {
        border-bottom: solid 1px grey;
    }
    .filter-container {
        position: relative;
        display: inline-block;
    }
    .filter-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 6px;
        transition: color 0.3s ease, background-color 0.3s ease;
    }
    .filter-label:hover {
        /* color: rgb(166, 166, 166); */
        /* background: #222; */
        opacity: 75%;
    }
    .filter-icon {
        width: 12px;
        height: 12px;
        transition: transform 0.3s ease;
    }
    .filter-label select:focus + .filter-icon,
    .filter-label select:active + .filter-icon {
        transform: rotate(-180deg);
    }

    /* Select styl√© */
    .filter-label select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 14px;
        padding-left: 5px;
        cursor: pointer;
        width: fit-content;
    }
    .filter-label option {
        background-color: #373b3f;
    }

    th, td { padding-left: 10px; padding-right: 25px; }
    .poster { height: 220px; width: 150px;}
    .listCards {
        margin: auto;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        grid-gap: 5px;
        grid-auto-rows: minmax(100px, auto);
        position: relative;
        width: fit-content;
        margin-bottom: 100px;
    }
    .carousel-item {
        display: none;
    }
    /* .card {
    }
    .card:hover {
    } */
    .cardPoster {
        position: relative;
        border-radius: 4%;
        border: solid 1px #666666;
        box-shadow: 0 5px 10px #14181c;
        margin: 2px;
        /* height: fit-content; */
        width: fit-content;
    }
    .cardPoster:hover {
        border: solid 3px #ffffff;
        margin: 0;
    }
    .poster{
        border-radius: 3%;
        height: 225px;
        width: 150px;
    }
    .serieTitle{
        position: absolute;
    }
</style>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">
        {{ message }}
    </div>
{% endfor %}

{% set filterOptions = {
    'type': types,
    'country': countries,
    'release_date': release_dates,
    'platform': platforms,
    'nb_season': nb_seasons,
    'status': status,
} %}

<header class="mb-5 px-5 py-2 bg-black d-flex justify-content-between align-items-center">
    <h1>CheckSerieBox</h1>
    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        <a href={{ path('app_logout') }} class="btn btn-info text-white">Logout</a>
    {% else %}
        <div class="d-flex justify-content-between align-items-center gap-3">
            <a href={{ path('app_login') }} class="btn btn-info text-white">Login</a>
            <a href={{ path('app_register') }} class="btn btn-info text-white">Sign in</a>
        </div>
    {% endif %}
</header>

<main class="px-5">
    <div style="">
        <h2 class="mb-5">Serie's list</h2>
        {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('serie_add') }}" class="btn btn-primary">Ajouter une s√©rie</a>
        {% else %}
            <form id="filtersList" class="filters d-flex justify-content-between align-items-center gap-3 mb-3">
                <p class="m-0">Filters</p>
                <div>
                    {% for name, options in filterOptions %}
                        <div class="filter-container">
                            <label class="filter-label">
                                <select name="{{ name }}">
                                    <option value="">{{ name|capitalize|replace({'_': ' '}) }}</option>
                                    {% for option in options %}
                                        <option value="{{ option|lower }}">{{ option|capitalize }}</option>
                                    {% endfor %}
                                </select>
                                <svg class="filter-icon" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                                    <path d="M165.6 349.8c-1.4 1.3-3.5 2.2-5.6 2.2s-4.2-.8-5.6-2.2L34.2 236.3c-1.4-1.3-2.2-3.2-2.2-5.2c0-3.9 3.2-7.1 7.1-7.1l241.7 0c3.9 0 7.1 3.2 7.1 7.1c0 2-.8 3.8-2.2 5.2L165.6 349.8zm22 23.3L307.7 259.6c7.8-7.4 12.3-17.7 12.3-28.4c0-21.6-17.5-39.1-39.1-39.1L39.1 192C17.5 192 0 209.5 0 231.1c0 10.8 4.4 21.1 12.3 28.5L132.4 373.1c7.4 7 17.3 10.9 27.6 10.9s20.1-3.9 27.6-10.9z"/>
                                </svg>
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </form>
        {% endif %}
    </div>

    {% if is_granted('ROLE_ADMIN') %}
        {# <form id="filtersTable" class="filters d-flex justify-content-between align-items-center gap-3 my-5">
            <p class="m-0">Filters</p>
            <div>
                {% for name, options in filterOptions %}
                    <div class="filter-container">
                        <label class="filter-label">{{ name|capitalize|replace({'_': ' '}) }}</label>
                        <select class="filter-label" name="{{ name }}">
                        <select class="" name="{{ name }}">
                            <option value="">{{ name|capitalize|replace({'_': ' '}) }}</option>
                            {% for option in options %}
                                <option value="{{ option|lower }}">{{ option|capitalize }}</option>
                            {% endfor %}
                        </select>
                        <svg class="filter-icon" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                            <path d="M165.6 349.8c-1.4 1.3-3.5 2.2-5.6 2.2s-4.2-.8-5.6-2.2L34.2 236.3c-1.4-1.3-2.2-3.2-2.2-5.2c0-3.9 3.2-7.1 7.1-7.1l241.7 0c3.9 0 7.1 3.2 7.1 7.1c0 2-.8 3.8-2.2 5.2L165.6 349.8zm22 23.3L307.7 259.6c7.8-7.4 12.3-17.7 12.3-28.4c0-21.6-17.5-39.1-39.1-39.1L39.1 192C17.5 192 0 209.5 0 231.1c0 10.8 4.4 21.1 12.3 28.5L132.4 373.1c7.4 7 17.3 10.9 27.6 10.9s20.1-3.9 27.6-10.9z"/>
                        </svg>
                    </div>
                {% endfor %}
            </div>
        </form> #}

        <table class="table table-dark table-striped">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Poster</th>
                    <th>Type</th>
                    <th>Pays</th>
                    <th>Date</th>
                    <th>Plateforme</th>
                    <th>Saison</th>
                    <th>Status</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody class="tableSerie">
                {% for serie in series %}
                    <tr>
                        <td>{{ serie.id }}</td>
                        <td>{{ serie.title }}</td>
                        <td><img src={{ serie.posterUrl }} style="max-height: 100px" alt={{ serie.title }} /></td>
                        <td>{{ serie.type|capitalize|replace({'_': ' '}) }}</td>
                        <td>{{ serie.country }}</td>
                        <td>{{ serie.releaseDate }}</td>
                        <td>{{ serie.platform }}</td>
                        <td>{{ serie.nbSeason }}</td>
                        <td>{{ serie.status|capitalize|replace({'_': ' '}) }}</td>
                        <td><span class="truncate-4" style="max-width: 200px;">{{ serie.synopsis }}</span></td>
                        <td>
                            <a href="{{ path('serie_edit', {id: serie.id}) }}" class="btn btn-primary">
                                <img src={{ asset('Images/edit.png') }} style="width: 20px; height: 20px;" alt="edit" />
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('serie_delete', {id: serie.id}) }}" class="btn btn-danger">
                                <img src={{ asset('Images/delete.png') }} style="width: 20px; height: 20px;" alt="delete" />
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="carousel-container">
            <div class="carousel-controls mx-auto w-50 d-flex justify-content-around align-items-center mb-4">
                <button id="prevBtn" class="btn btn-secondary py-1">‚Üê</button>
                <span id="pageIndicator">currentPage </span>
                <button id="nextBtn" class="btn btn-secondary py-0">‚Üí</button>
            </div>
            <ul class="listCards" id="carousel">
                {% for serieRandom in seriesRandomLimited %}
                    <li class="bg-dark carousel-item">
                        <article class="cardPoster">
                            <img class="poster" src={{ serieRandom.poster_url }} alt={`poster {{ serieRandom.title }}`} />
                        </article>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

</main>

<script>

    // -------------------- Carrousel de s√©ries --------------------
    const itemsPerPage = 24;
    let currentPage = 0;

    function getItems() {
        return document.querySelectorAll('.carousel-item');
    }

    function getTotalPages() {
        return Math.ceil(getItems().length / itemsPerPage);
    }

    const pageIndicator = document.getElementById('pageIndicator');

    function updatePageIndicator() {
        const totalPages = getTotalPages();
        pageIndicator.textContent = `Page ${currentPage + 1} / ${totalPages}`;
    }

    function updateButtonsVisibility() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const totalPages = getTotalPages();

        prevBtn.style.visibility = currentPage === 0 ? 'hidden' : 'visible';
        nextBtn.style.visibility = currentPage >= totalPages - 1 ? 'hidden' : 'visible';
    }

    function showPage(page) {
        const items = getItems();
        const start = page * itemsPerPage;
        const end = start + itemsPerPage;

        items.forEach((item, index) => {
            item.style.display = (index >= start && index < end) ? 'block' : 'none';
        });

        updatePageIndicator();
        updateButtonsVisibility();
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
        const totalPages = getTotalPages();
        if (currentPage < totalPages - 1) {
            currentPage++;
            showPage(currentPage);
        }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            showPage(currentPage);
        }
    });

    showPage(currentPage);


    // -------------------- Filtres d'affichage s√©ries --------------------

    function updateList(series) {
        const list = document.querySelector('.listCards');
        if (!list) return;

        list.innerHTML = '';
        series.forEach(serie => {
            list.insertAdjacentHTML('beforeend', `
                <li class="bg-dark carousel-item">
                    <article class="cardPoster">
                        <img class="poster" src="${serie.posterUrl}" alt="${serie.title}">
                    </article>
                </li>
            `);
        });

        currentPage = 0;
        showPage(currentPage);
    }

    function updateTable(series) {
        const tbody = document.querySelector('.tableSerie');
        if (!tbody) return;

        tbody.innerHTML = '';
        series.forEach(serie => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${serie.id}</td>
                    <td>${serie.title}</td>
                    <td><img src="${serie.posterUrl}" style="max-height:100px"></td>
                    <td>${serie.type}</td>
                    <td>${serie.country}</td>
                    <td>${serie.releaseDate}</td>
                    <td>${serie.platform}</td>
                    <td>${serie.nbSeason}</td>
                    <td>${serie.status}</td>
                    <td class="truncate-4">${serie.synopsis}</td>
                </tr>
            `);
        });
    }

    function updateView(series) {
        if (document.querySelector('.listCards')) {
            updateList(series);
        }

        if (document.querySelector('.tableSerie')) {
            updateTable(series);
        }
    }

    // function bindFilters(form) {
    //     if (!form) return;

    //     form.addEventListener('change', () => {
    //         const params = new URLSearchParams(new FormData(form));

    //         fetch('/api/series?' + params.toString())
    //             .then(res => res.json())
    //             .then(updateView)
    //             .catch(console.error);
    //     });
    //     console.log([...new FormData(form)]);

    // }

    // bindFilters(document.getElementById('filtersList'));
    // bindFilters(document.getElementById('filtersTable'));

    // document.addEventListener('DOMContentLoaded', () => {
    //     const forms = document.querySelectorAll('#filtersList, #filtersTable');

    //     forms.forEach(form => {
    //         form.addEventListener('change', () => {
    //             const data = new FormData(form);
    //             const params = new URLSearchParams();

    //             for (const [key, value] of data.entries()) {
    //                 if (value !== '') {
    //                     params.append(key, value);
    //                 }
    //             }

    //             fetch('/api/series?' + params.toString())
    //                 .then(res => res.json())
    //                 .then(updateView)
    //                 .catch(console.error);
    //         });
    //     });
    // });

    document.addEventListener('DOMContentLoaded', () => {
        const tableForm = document.getElementById('filtersTable');

        if (!tableForm) {
            console.log('‚ùå filtersTable introuvable');
            return;
        }

        console.log('‚úÖ filtersTable trouv√©');

        tableForm.addEventListener('change', (e) => {
            console.log('üî• CHANGE d√©clench√© sur filtersTable');
            console.log('Champ modifi√© :', e.target.name, e.target.value);

            const data = new FormData(tableForm);
            console.log('üì¶ FormData :', [...data.entries()]);
        });
    });



</script>

{% endblock %}
